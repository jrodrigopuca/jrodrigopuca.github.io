<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebXR AR/VR Frame</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      #ui {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      button {
        padding: 6px 12px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <button onclick="setAspect(3, 2)">3:2</button>
      <button onclick="setAspect(4, 3)">4:3</button>
      <button onclick="setAspect(1, 1)">1:1</button>
      <button onclick="setAspect(16, 9)">16:9</button>
      <button onclick="enterAR()">Entrar en AR</button>
      <button onclick="enterVR()">Entrar en VR</button>
    </div>

    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
      import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/webxr/ARButton.js';
      import { XRControllerModelFactory } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/webxr/XRControllerModelFactory.js';

      let camera, scene, renderer;
      let frameMesh;
      let aspectW = 3, aspectH = 2;
      let controller, controllerGrip, raycasterLine;

      init();

      function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera();

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Frame material
        const material = new THREE.MeshBasicMaterial({
          color: 0x000000,
          side: THREE.DoubleSide,
          opacity: 0.5,
          transparent: true,
        });

        // Marco inicial visible
        frameMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 0.3 * aspectH / aspectW), material);
        frameMesh.position.set(0, 1.5, -1); // Frente al usuario
        scene.add(frameMesh);

        // Controlador (con raycaster)
        controller = renderer.xr.getController(0);
        controller.addEventListener('selectstart', onSelect);
        scene.add(controller);

        raycasterLine = new THREE.Line(
          new THREE.BufferGeometry().setFromPoints([
            new THREE.Vector3(0, 0, 0),
            new THREE.Vector3(0, 0, -1)
          ]),
          new THREE.LineBasicMaterial({ color: 0xff0000 })
        );
        raycasterLine.name = 'raycaster-line';
        controller.add(raycasterLine);

        // Visual del controlador (modelo)
        const controllerModelFactory = new XRControllerModelFactory();
        controllerGrip = renderer.xr.getControllerGrip(0);
        controllerGrip.add(controllerModelFactory.createControllerModel(controllerGrip));
        scene.add(controllerGrip);

        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      }

      function onSelect() {
        const referenceSpace = renderer.xr.getReferenceSpace();
        const frame = renderer.xr.getFrame();

        const viewerPose = frame.getViewerPose(referenceSpace);
        if (!viewerPose) return;

        const pos = viewerPose.transform.position;
        const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);

        const distance = 0.5;
        const targetPos = new THREE.Vector3(
          pos.x + dir.x * distance,
          pos.y + dir.y * distance,
          pos.z + dir.z * distance
        );

        frameMesh.position.copy(targetPos);
        frameMesh.lookAt(new THREE.Vector3(pos.x, pos.y, pos.z));
      }

      window.setAspect = function (w, h) {
        aspectW = w;
        aspectH = h;
        const newGeo = new THREE.PlaneGeometry(0.3, 0.3 * h / w);
        frameMesh.geometry.dispose();
        frameMesh.geometry = newGeo;
      };

      window.enterAR = function () {
        navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['camera-access'],
          optionalFeatures: ['dom-overlay'],
          domOverlay: { root: document.body }
        }).then((session) => {
          renderer.xr.setSession(session);
        }).catch((err) => console.warn("AR no disponible:", err));
      };

      window.enterVR = function () {
        navigator.xr.requestSession('immersive-vr', {
          optionalFeatures: ['local-floor']
        }).then((session) => {
          renderer.xr.setSession(session);
        }).catch((err) => console.warn("VR no disponible:", err));
      };
    </script>
  </body>
</html>